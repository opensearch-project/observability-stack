# Saved queries for OpenSearch Dashboards
# These queries are automatically created during initialization
# and provide quick access to common agent observability patterns

queries:
  - id: all_agent_invocations
    title: All agent invocations
    description: Find all agent invocation spans
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE `attributes.gen_ai.operation.name` = 'invoke_agent'

  - id: tool_executions
    title: Tool executions
    description: Find all tool execution spans
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE `attributes.gen_ai.operation.name` = 'execute_tool'

  - id: high_token_usage
    title: High token usage
    description: Find spans with high token usage (>1000 tokens)
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE `attributes.gen_ai.usage.input_tokens` + `attributes.gen_ai.usage.output_tokens` > 1000

  - id: error_spans
    title: Error spans
    description: Find spans with errors
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE `status.code` = 2

  - id: slow_operations
    title: Slow operations
    description: Find operations taking longer than 5 seconds
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE `durationInNanos` > 5000000000

  - id: agent_by_model
    title: LLM requests by model
    description: Count LLM spans grouped by model
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE NOT isnull(`attributes.gen_ai.request.model`) AND NOT isnull(`traceId`)
      | stats count() by `attributes.gen_ai.request.model`

  - id: tool_usage_stats
    title: Tool usage statistics
    description: Count tool execution spans by tool name
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE NOT isnull(`attributes.gen_ai.tool.name`) AND NOT isnull(`traceId`)
      | stats count() by `attributes.gen_ai.tool.name`

  - id: token_usage_by_agent
    title: Token usage by agent
    description: Sum token usage from spans grouped by agent name
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE NOT isnull(`attributes.gen_ai.agent.name`) AND NOT isnull(`traceId`)
      | stats sum(`attributes.gen_ai.usage.input_tokens`) as input_tokens,
              sum(`attributes.gen_ai.usage.output_tokens`) as output_tokens
        by `attributes.gen_ai.agent.name`

  - id: token_usage_by_model
    title: Token usage by model
    description: Sum token usage from spans grouped by model name
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE NOT isnull(`attributes.gen_ai.request.model`) AND NOT isnull(`traceId`)
      | stats sum(`attributes.gen_ai.usage.input_tokens`) as input_tokens,
              sum(`attributes.gen_ai.usage.output_tokens`) as output_tokens
        by `attributes.gen_ai.request.model`

  - id: agent_operation_names
    title: Agent operations used by services
    description: Agent operations used by services
    language: PPL
    query: |
      source=otel-v1-apm-span-*
      | WHERE NOT isnull(`attributes.gen_ai.operation.name`)
      | stats count() as operations by serviceName, `attributes.gen_ai.operation.name`
